---
import PostPageContent from '@/components/PostPageContent.astro'
import {
  getAllQuotesAndSubposts,
  getQuoteCombinedReadingTime,
  getQuoteParentId,
  getQuoteParentPost,
  getQuoteReadingTime,
  getQuoteSubpostCount,
  getQuoteTOCSections,
  hasQuoteSubposts,
  isQuoteSubpost,
  parseAuthors,
} from '@/lib/collections'
import { render } from 'astro:content'

export async function getStaticPaths() {
  const quotes = await getAllQuotesAndSubposts()
  return quotes.map((quote) => ({
    params: { id: quote.id },
    props: quote,
  }))
}

const quote = Astro.props
const currentQuoteId = Astro.params.id
const { Content, headings } = await render(quote)
const authors = await parseAuthors(quote.data.authors ?? [])

const isCurrentSubpost = isQuoteSubpost(currentQuoteId)
const parentQuote = isCurrentSubpost ? await getQuoteParentPost(currentQuoteId) : null

const hasChildPosts = await hasQuoteSubposts(currentQuoteId)
const subpostCount = !isCurrentSubpost
  ? await getQuoteSubpostCount(currentQuoteId)
  : 0
const quoteReadingTime = await getQuoteReadingTime(currentQuoteId)
const combinedReadingTime =
  hasChildPosts && !isCurrentSubpost
    ? await getQuoteCombinedReadingTime(currentQuoteId)
    : null

const tocSections = await getQuoteTOCSections(currentQuoteId)
---

<PostPageContent
  post={quote}
  collection="quote"
  basePath="/quote"
  currentPostId={currentQuoteId}
  Content={Content}
  headings={headings}
  authors={authors}
  isCurrentSubpost={isCurrentSubpost}
  parentPost={parentQuote}
  hasChildPosts={hasChildPosts}
  subpostCount={subpostCount}
  postReadingTime={quoteReadingTime}
  combinedReadingTime={combinedReadingTime}
  tocSections={tocSections}
  navigation={undefined}
  getParentId={getQuoteParentId}
/>
