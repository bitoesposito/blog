---
// Banner visibile che indica la presenza di subpost disponibili
// Utile soprattutto su mobile dove i subpost sono nascosti nel dropdown
import Link from '@/components/Link.astro'
import { buttonVariants } from '@/components/ui/button'
import {
  getQuoteParentId,
  getQuoteParentPost,
  getQuoteById,
  getQuoteSubpostsForParent,
  isQuoteSubpost,
} from '@/lib/data-utils'
import { Icon } from 'astro-icon/components'

const { parentId, currentPostId, parentShareId } = Astro.props
const isCurrentSubpost = isQuoteSubpost(currentPostId)
const rootParentId = isCurrentSubpost ? getQuoteParentId(currentPostId) : parentId

const currentPost = !isCurrentSubpost ? await getQuoteById(currentPostId) : null
const subposts = await getQuoteSubpostsForParent(rootParentId)
const parentPost = isCurrentSubpost ? await getQuoteParentPost(currentPostId) : null

// Funzione helper per generare URL usando shareId quando disponibile
function getQuoteUrl(quoteId: string, shareId?: string): string {
  if (shareId && isQuoteSubpost(quoteId)) {
    // Per i subpost, usa shareId + nome subpost
    const subpostName = quoteId.split('/').slice(1).join('/')
    return `/quote/${shareId}/${subpostName}`
  } else if (shareId) {
    return `/quote/${shareId}`
  }
  return `/quote/${quoteId}`
}

// Mostra il banner solo se ci sono subpost disponibili
const hasSubposts = subposts.length > 0
const activePost = parentPost || currentPost

// Se siamo su un subpost, prendiamo il primo subpost non ancora letto
// Se siamo sul post principale, prendiamo il primo subpost disponibile
const firstSubpost = subposts.length > 0 ? subposts[0] : null
const currentSubpostIndex = isCurrentSubpost
  ? subposts.findIndex((s) => s.id === currentPostId)
  : -1
const nextSubpost =
  currentSubpostIndex >= 0 && currentSubpostIndex < subposts.length - 1
    ? subposts[currentSubpostIndex + 1]
    : null
---

{
  hasSubposts && (
    <div
      class="col-start-2 mx-auto w-full max-w-3xl xl:hidden"
      id="subposts-banner"
    >
      <div class="bg-muted/50 border-border rounded-lg border p-4">
        <div class="flex flex-col gap-3">
          <div class="flex items-start gap-3">
            <Icon
              name="lucide:file-text"
              class="mt-0.5 size-5 flex-shrink-0 text-primary"
              aria-hidden="true"
            />
            <div class="flex-1">
              <h3 class="text-foreground mb-1 text-sm font-semibold">
                {isCurrentSubpost
                  ? 'Continua la lettura'
                  : 'Questo preventivo contiene pi√π documenti'}
              </h3>
              <p class="text-muted-foreground text-xs leading-relaxed">
                {isCurrentSubpost
                  ? nextSubpost
                    ? `Leggi il prossimo documento: "${nextSubpost.data.title}"`
                    : `Hai completato tutti i ${subposts.length + 1} documenti di questo preventivo.`
                  : `Questo preventivo contiene ${subposts.length} documento${
                      subposts.length === 1 ? '' : 'i'
                    } aggiuntivi.`}
              </p>
            </div>
          </div>

          <div class="flex flex-col gap-2 sm:flex-row">
            {isCurrentSubpost && nextSubpost ? (
              <Link
                href={`/quote/${nextSubpost.id}`}
                class={buttonVariants({ variant: 'default', size: 'sm' })}
                aria-label={`Continua a leggere: ${nextSubpost.data.title}`}
              >
                <span>Continua a leggere</span>
                <Icon name="lucide:arrow-right" class="size-4" aria-hidden="true" />
              </Link>
            ) : isCurrentSubpost && !nextSubpost && parentPost ? (
              <Link
                href={getQuoteUrl(parentPost.id, parentShareId || parentPost.data.shareId)}
                class={buttonVariants({ variant: 'outline', size: 'sm' })}
                aria-label={`Torna all'indice: ${parentPost.data.title}`}
              >
                <Icon name="lucide:corner-left-up" class="size-4" aria-hidden="true" />
                <span>Torna all'indice</span>
              </Link>
            ) : firstSubpost ? (
              <Link
                href={getQuoteUrl(firstSubpost.id, parentShareId || firstSubpost.data.shareId)}
                class={buttonVariants({ variant: 'default', size: 'sm' })}
                aria-label={`Inizia a leggere: ${firstSubpost.data.title}`}
              >
                <span>Inizia a leggere</span>
                <Icon name="lucide:arrow-right" class="size-4" aria-hidden="true" />
              </Link>
            ) : null}

            <button
              type="button"
              onclick="document.getElementById('mobile-subposts-container')?.querySelector('details')?.setAttribute('open', '')"
              class={buttonVariants({ variant: 'outline', size: 'sm' })}
              aria-label={`Mostra tutti i ${subposts.length + (activePost ? 1 : 0)} documenti disponibili`}
            >
              <Icon name="lucide:list" class="size-4" aria-hidden="true" />
              <span>
                Vedi tutti ({subposts.length + (activePost ? 1 : 0)})
              </span>
            </button>
          </div>
        </div>
      </div>
    </div>
  )
}

