---
import Link from '@/components/Link.astro'
import { ScrollArea } from '@/components/ui/scroll-area'
import {
  getQuoteCombinedReadingTime,
  getQuoteParentId,
  getQuoteParentPost,
  getQuoteById,
  getQuoteReadingTime,
  getQuoteSubpostsForParent,
  isQuoteSubpost,
} from '@/lib/collections'
import { Icon } from 'astro-icon/components'

const { parentId } = Astro.props
const currentPostId = (Astro.params.id as string) || parentId
const isCurrentSubpost = isQuoteSubpost(currentPostId)
const rootParentId = isCurrentSubpost ? getQuoteParentId(currentPostId) : parentId

const currentPost = !isCurrentSubpost ? await getQuoteById(currentPostId) : null
const subposts = await getQuoteSubpostsForParent(rootParentId)
const parentPost = isCurrentSubpost ? await getQuoteParentPost(currentPostId) : null

const activePost = parentPost || currentPost
const isActivePost = activePost?.id === currentPostId

const activePostReadingTime = activePost
  ? await getQuoteReadingTime(activePost.id)
  : null
const activePostCombinedReadingTime =
  activePost && subposts.length > 0
    ? await getQuoteCombinedReadingTime(activePost.id)
    : null

const subpostsWithReadingTime = await Promise.all(
  subposts.map(async (subpost) => ({
    ...subpost,
    readingTime: await getQuoteReadingTime(subpost.id),
  })),
)

// Organizza i documenti per struttura gerarchica (cartelle)
type FolderStructure = {
  name: string
  files: Array<{ id: string; title: string; readingTime: string; isActive: boolean }>
  folders: Record<string, FolderStructure>
}

function organizeByFolders(
  posts: Array<{ id: string; data: { title: string; order?: number }; readingTime: string }>,
  currentId: string,
  parentId: string,
): FolderStructure {
  const structure: FolderStructure = {
    name: '',
    files: [],
    folders: {},
  }

  for (const post of posts) {
    const isActive = post.id === currentId
    // Rimuovi il parentId dall'inizio dell'ID per ottenere il path relativo
    const relativePath = post.id.startsWith(parentId + '/') 
      ? post.id.slice(parentId.length + 1)
      : post.id
    
    const parts = relativePath.split('/')

    if (parts.length === 1) {
      // File nella root (dopo il parentId)
      structure.files.push({
        id: post.id,
        title: post.data.title,
        readingTime: post.readingTime,
        isActive,
      })
    } else {
      // File in una cartella
      const folderName = parts[0]

      if (!structure.folders[folderName]) {
        structure.folders[folderName] = {
          name: folderName,
          files: [],
          folders: {},
        }
      }

      structure.folders[folderName].files.push({
        id: post.id,
        title: post.data.title,
        readingTime: post.readingTime,
        isActive,
      })
    }
  }

  // Ordina i file per order o title
  structure.files.sort((a, b) => {
    const aPost = posts.find((p) => p.id === a.id)
    const bPost = posts.find((p) => p.id === b.id)
    const aOrder = (aPost as any)?.data?.order ?? 0
    const bOrder = (bPost as any)?.data?.order ?? 0
    if (aOrder !== bOrder) return aOrder - bOrder
    return a.title.localeCompare(b.title)
  })

  // Ordina le cartelle e i loro file
  for (const folderName in structure.folders) {
    structure.folders[folderName].files.sort((a, b) => {
      const aPost = posts.find((p) => p.id === a.id)
      const bPost = posts.find((p) => p.id === b.id)
      const aOrder = (aPost as any)?.data?.order ?? 0
      const bOrder = (bPost as any)?.data?.order ?? 0
      if (aOrder !== bOrder) return aOrder - bOrder
      return a.title.localeCompare(b.title)
    })
  }

  return structure
}

const folderStructure = organizeByFolders(subpostsWithReadingTime, currentPostId, rootParentId)
---

<div
  id="subposts-sidebar-container"
  class="sticky top-20 col-start-1 row-span-1 mr-8 ml-auto hidden h-[calc(100vh-5rem)] max-w-md xl:block"
>
  <ScrollArea
    client:load
    className="flex max-h-[calc(100vh-8rem)] flex-col overflow-y-auto"
    data-subposts-sidebar-scroll
  >
    <div class="px-4">
      <ul class="space-y-1" aria-label="Struttura documenti del preventivo">
        {
          activePost && (
            <li>
              {isActivePost ? (
                <div class="text-foreground bg-muted subposts-sidebar-active-item flex items-center gap-2 rounded-md py-1.5 pr-3 pl-2 text-sm font-medium text-pretty">
                  <Icon
                    name="lucide:folder-open"
                    class="size-4 flex-shrink-0"
                    aria-hidden="true"
                  />
                  <div class="flex flex-col">
                    <span class="line-clamp-2 text-pretty">
                      {activePost.data.title}
                    </span>
                    {activePostReadingTime && (
                      <span class="text-muted-foreground/80 text-xs">
                        {activePostReadingTime}
                        {activePostCombinedReadingTime &&
                          activePostCombinedReadingTime !==
                            activePostReadingTime && (
                            <span>
                              {' '}
                              ({activePostCombinedReadingTime} total)
                            </span>
                          )}
                      </span>
                    )}
                  </div>
                </div>
              ) : (
                <Link
                  href={`/quote/${activePost.id}#post-title`}
                  class="hover:text-foreground text-muted-foreground hover:bg-muted/50 subposts-sidebar-link flex items-center gap-2 rounded-md px-2 py-1.5 text-sm text-pretty transition-colors"
                  aria-label={`Vai al documento principale: ${activePost.data.title}`}
                >
                  <Icon
                    name="lucide:folder"
                    class="size-4 flex-shrink-0"
                    aria-hidden="true"
                  />
                  <div class="flex flex-col">
                    <span class="line-clamp-2 text-pretty">
                      {activePost.data.title}
                    </span>
                    {activePostReadingTime && (
                      <span class="text-muted-foreground/80 text-xs">
                        {activePostReadingTime}
                        {activePostCombinedReadingTime &&
                          activePostCombinedReadingTime !==
                            activePostReadingTime && (
                            <span>
                              {' '}
                              ({activePostCombinedReadingTime} total)
                            </span>
                          )}
                      </span>
                    )}
                  </div>
                </Link>
              )}
            </li>
          )
        }

        {
          folderStructure.files.length > 0 && (
            <li class="space-y-1">
              {folderStructure.files.map((file) => (
                file.isActive ? (
                  <div class="text-foreground bg-muted subposts-sidebar-active-item flex items-center gap-2 rounded-md px-2 py-1.5 text-sm font-medium text-pretty">
                    <Icon
                      name="lucide:file-text"
                      class="size-4 flex-shrink-0"
                      aria-hidden="true"
                    />
                    <div class="flex flex-col">
                      <span class="line-clamp-2 text-pretty">
                        {file.title}
                      </span>
                      <span class="text-muted-foreground/80 text-xs">
                        {file.readingTime}
                      </span>
                    </div>
                  </div>
                ) : (
                  <Link
                    href={`/quote/${file.id}#post-title`}
                    class="hover:text-foreground text-muted-foreground hover:bg-muted/50 subposts-sidebar-link flex items-center gap-2 rounded-md px-2 py-1.5 text-sm text-pretty transition-colors"
                    aria-label={`Vai al documento: ${file.title}`}
                  >
                    <Icon
                      name="lucide:file"
                      class="size-4 flex-shrink-0"
                      aria-hidden="true"
                    />
                    <div class="flex flex-col">
                      <span class="line-clamp-2 text-pretty">
                        {file.title}
                      </span>
                      <span class="text-muted-foreground/80 text-xs">
                        {file.readingTime}
                      </span>
                    </div>
                  </Link>
                )
              ))}
            </li>
          )
        }

        {
          Object.keys(folderStructure.folders).length > 0 && (
            <li class="space-y-1">
              {Object.entries(folderStructure.folders)
                .sort(([a], [b]) => a.localeCompare(b))
                .map(([folderName, folder]) => {
                  const folderId = `folder-${folderName}`
                  const hasActiveFile = folder.files.some((f) => f.isActive)
                  return (
                    <div class="space-y-1" data-folder-container>
                      <details
                        class="group"
                        open={hasActiveFile}
                        data-folder={folderId}
                      >
                        <summary class="text-foreground hover:text-foreground/80 bg-muted/30 hover:bg-muted/50 cursor-pointer flex items-center gap-2.5 px-3 py-2.5 text-sm font-semibold rounded-md transition-colors list-none border border-border/50">
                          <Icon
                            name="lucide:chevron-right"
                            class="size-4 flex-shrink-0 transition-transform duration-200 group-open:rotate-90"
                            aria-hidden="true"
                          />
                          <Icon
                            name={hasActiveFile ? "lucide:folder-open" : "lucide:folder"}
                            class="size-5 flex-shrink-0"
                            aria-hidden="true"
                          />
                          <span class="uppercase tracking-wide">{folderName}</span>
                        </summary>
                        <ul class="ml-4 mt-1 space-y-1">
                          {folder.files.map((file) =>
                            file.isActive ? (
                              <li>
                                <div class="text-foreground bg-muted subposts-sidebar-active-item flex items-center gap-2 rounded-md px-2 py-1.5 text-sm font-medium text-pretty">
                                  <Icon
                                    name="lucide:file-text"
                                    class="size-4 flex-shrink-0"
                                    aria-hidden="true"
                                  />
                                  <div class="flex flex-col">
                                    <span class="line-clamp-2 text-pretty">
                                      {file.title}
                                    </span>
                                    <span class="text-muted-foreground/80 text-xs">
                                      {file.readingTime}
                                    </span>
                                  </div>
                                </div>
                              </li>
                            ) : (
                              <li>
                                <Link
                                  href={`/quote/${file.id}#post-title`}
                                  class="hover:text-foreground text-muted-foreground hover:bg-muted/50 subposts-sidebar-link flex items-center gap-2 rounded-md px-2 py-1.5 text-sm text-pretty transition-colors"
                                  aria-label={`Vai al documento: ${file.title}`}
                                >
                                  <Icon
                                    name="lucide:file"
                                    class="size-4 flex-shrink-0"
                                    aria-hidden="true"
                                  />
                                  <div class="flex flex-col">
                                    <span class="line-clamp-2 text-pretty">
                                      {file.title}
                                    </span>
                                    <span class="text-muted-foreground/80 text-xs">
                                      {file.readingTime}
                                    </span>
                                  </div>
                                </Link>
                              </li>
                            ),
                          )}
                        </ul>
                      </details>
                    </div>
                  )
                })}
            </li>
          )
        }
      </ul>
    </div>
  </ScrollArea>
</div>

<script>
  class SidebarState {
    scrollArea: HTMLElement | null = null
    sidebarScrollArea: HTMLElement | null = null

    reset() {
      this.scrollArea = null
      this.sidebarScrollArea = null
    }
  }

  const state = new SidebarState()

  class SidebarScrollMask {
    static update() {
      if (!state.scrollArea || !state.sidebarScrollArea) return

      const { scrollTop, scrollHeight, clientHeight } = state.scrollArea
      const threshold = 5
      const isAtTop = scrollTop <= threshold
      const isAtBottom = scrollTop >= scrollHeight - clientHeight - threshold

      state.sidebarScrollArea.classList.toggle('mask-t-from-90%', !isAtTop)
      state.sidebarScrollArea.classList.toggle('mask-b-from-90%', !isAtBottom)
    }
  }

  class SidebarScroll {
    static toActive() {
      if (!state.scrollArea) return

      const activeItem = state.scrollArea.querySelector(
        '.subposts-sidebar-active-item',
      )
      if (!activeItem) {
        return
      }

      const { top: areaTop, height: areaHeight } =
        state.scrollArea.getBoundingClientRect()
      const { top: itemTop, height: itemHeight } =
        activeItem.getBoundingClientRect()

      const currentItemTop = itemTop - areaTop + state.scrollArea.scrollTop
      const targetScroll = Math.max(
        0,
        Math.min(
          currentItemTop - (areaHeight - itemHeight) / 2,
          state.scrollArea.scrollHeight - state.scrollArea.clientHeight,
        ),
      )

      state.scrollArea.scrollTop = targetScroll
    }
  }

  class SidebarController {
    static init() {
      state.reset()

      const sidebarContainer = document.getElementById(
        'subposts-sidebar-container',
      )
      if (sidebarContainer) {
        state.scrollArea = sidebarContainer.querySelector(
          '[data-radix-scroll-area-viewport]',
        )
        state.sidebarScrollArea = sidebarContainer.querySelector(
          '[data-subposts-sidebar-scroll]',
        )

        if (state.scrollArea) {
          state.scrollArea.addEventListener(
            'scroll',
            SidebarScrollMask.update,
            { passive: true },
          )
        }

        requestAnimationFrame(() => {
          SidebarScroll.toActive()
          setTimeout(SidebarScrollMask.update, 100)
        })
      }
    }

    static cleanup() {
      if (state.scrollArea) {
        state.scrollArea.removeEventListener('scroll', SidebarScrollMask.update)
      }
      state.reset()
    }
  }

  document.addEventListener('astro:page-load', () => SidebarController.init())
  document.addEventListener('astro:after-swap', () => {
    SidebarController.cleanup()
    SidebarController.init()
  })
  document.addEventListener('astro:before-swap', () =>
    SidebarController.cleanup(),
  )
</script>

